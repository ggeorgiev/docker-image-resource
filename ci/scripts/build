#!/usr/bin/env bash
pushd `dirname $0` > /dev/null; BASEDIR=`pwd`; popd > /dev/null

set -ex

BUILT_RESOURCE=$PWD/built-resource

DIR=$GOPATH/src/github.com/concourse/docker-image-resource
mkdir -p $DIR

cd $BASEDIR/../..
cp -r . $DIR

cd $DIR
go get cmd/...

OUT=$BASEDIR/../../../docker
mkdir -p $BUILT_RESOURCE
mkdir -p $OUT/assets
mkdir -p $OUT/built-resource

cp Dockerfile $OUT
cp assets/* $OUT/assets

go install github.com/concourse/docker-image-resource/vendor/github.com/onsi/ginkgo/ginkgo

CGO_ENABLED=1 ginkgo -race -r -p

go build -o $OUT/assets/check ./cmd/check/
go build -o $OUT/print-metadata ./cmd/print-metadata/
go build -o $OUT/buildcache github.com/concourse/docker-image-resource/vendor/github.com/tonistiigi/buildcache/cmd/buildcache
go build -o $OUT/ecr-login github.com/concourse/docker-image-resource/vendor/github.com/awslabs/amazon-ecr-credential-helper/ecr-login/cmd

pushd $OUT
curl -sSL -O https://get.docker.com/builds/Linux/x86_64/docker-1.12.1.tgz
tar zxf docker-1.12.1.tgz
popd

cp -a ./* ${BUILT_RESOURCE}/

